import{a8 as q,f as b,a4 as oe,a5 as ie,o as se,S as g,U as x,V as I,W as _,k as d,u as O,G as f,X as c,F as N,Y as U,Z as L,_ as M}from"./vendor-e4b530e5.js";import{S as ae,u as re}from"./nodeTemplate-e600a04d.js";import{m as $,W as le,a3 as de,o as ue}from"./antd-19bac614.js";import{_ as ce}from"./index-053c0381.js";function pe(){return typeof window<"u"?window.console:global.console}const D=pe();function me(e){const t=Object.create(null);return function(o){return t[o]||(t[o]=e(o))}}const fe=/-(\w)/g,F=me(e=>e.replace(fe,(t,n)=>n?n.toUpperCase():""));function k(e){e.parentElement!==null&&e.parentElement.removeChild(e)}function j(e,t,n){const o=n===0?e.children[0]:e.children[n-1].nextSibling;e.insertBefore(t,o)}function he(e,t,n){return n===void 0||(e=e||{},e[t]=n),e}function ge(e,t){return e.map(n=>n.elm).indexOf(t)}function ve(e,t,n,o){if(!e)return[];const i=e.map(m=>m.elm),r=t.length-o,u=[...t].map((m,p)=>p>=r?i.length:i.indexOf(m));return n?u.filter(m=>m!==-1):u}function B(e,t){this.$nextTick(()=>this.$emit(e.toLowerCase(),t))}function xe(e){return t=>{this.realList!==null&&this["onDrag"+e](t),B.call(this,e,t)}}function R(e){return["transition-group","TransitionGroup"].includes(e)}function _e(e){if(!e||e.length!==1)return!1;const[{componentOptions:t}]=e;return t?R(t.tag):!1}function E(e,t,n){return e[n]||(t[n]?t[n]():void 0)}function ye(e,t,n){let o=0,i=0;const r=E(t,n,"header");r&&(o=r.length,e=e?[...r,...e]:[...r]);const u=E(t,n,"footer");return u&&(i=u.length,e=e?[...e,...u]:[...u]),{children:e,headerOffset:o,footerOffset:i}}function be(e,t){let n=null;const o=(p,v)=>{n=he(n,p,v)},i=Object.keys(e).filter(p=>p==="id"||p.startsWith("data-")).reduce((p,v)=>(p[v]=e[v],p),{});if(o("attrs",i),!t)return n;const{on:r,props:u,attrs:m}=t;return o("on",r),o("props",u),Object.assign(n.attrs,m),n}const z=["Start","Add","Remove","Update","End"],H=["Choose","Unchoose","Sort","Filter","Clone"],Ce=["Move",...z,...H].map(e=>"on"+e);var A=null;const we={options:Object,list:{type:Array,required:!1,default:null},value:{type:Array,required:!1,default:null},noTransitionOnDrag:{type:Boolean,default:!1},clone:{type:Function,default:e=>e},element:{type:String,default:"div"},tag:{type:String,default:null},move:{type:Function,default:null},componentData:{type:Object,required:!1,default:null}},J={name:"draggable",inheritAttrs:!1,props:we,data(){return{transitionMode:!1,noneFunctionalComponentMode:!1}},render(e){const t=this.$slots.default;this.transitionMode=_e(t);const{children:n,headerOffset:o,footerOffset:i}=ye(t,this.$slots,this.$scopedSlots);this.headerOffset=o,this.footerOffset=i;const r=be(this.$attrs,this.componentData);return e(this.getTag(),r,n)},created(){this.list!==null&&this.value!==null&&D.error("Value and list props are mutually exclusive! Please set one or another."),this.element!=="div"&&D.warn("Element props is deprecated please use tag props instead. See https://github.com/SortableJS/Vue.Draggable/blob/master/documentation/migrate.md#element-props"),this.options!==void 0&&D.warn("Options props is deprecated, add sortable options directly as vue.draggable item, or use v-bind. See https://github.com/SortableJS/Vue.Draggable/blob/master/documentation/migrate.md#options-props")},mounted(){if(this.noneFunctionalComponentMode=this.getTag().toLowerCase()!==this.$el.nodeName.toLowerCase()&&!this.getIsFunctional(),this.noneFunctionalComponentMode&&this.transitionMode)throw new Error(`Transition-group inside component is not supported. Please alter tag value or remove transition-group. Current tag value: ${this.getTag()}`);const e={};z.forEach(o=>{e["on"+o]=xe.call(this,o)}),H.forEach(o=>{e["on"+o]=B.bind(this,o)});const t=Object.keys(this.$attrs).reduce((o,i)=>(o[F(i)]=this.$attrs[i],o),{}),n=Object.assign({},this.options,t,e,{onMove:(o,i)=>this.onDragMove(o,i)});!("draggable"in n)&&(n.draggable=">*"),this._sortable=new ae(this.rootContainer,n),this.computeIndexes()},beforeDestroy(){this._sortable!==void 0&&this._sortable.destroy()},computed:{rootContainer(){return this.transitionMode?this.$el.children[0]:this.$el},realList(){return this.list?this.list:this.value}},watch:{options:{handler(e){this.updateOptions(e)},deep:!0},$attrs:{handler(e){this.updateOptions(e)},deep:!0},realList(){this.computeIndexes()}},methods:{getIsFunctional(){const{fnOptions:e}=this._vnode;return e&&e.functional},getTag(){return this.tag||this.element},updateOptions(e){for(var t in e){const n=F(t);Ce.indexOf(n)===-1&&this._sortable.option(n,e[t])}},getChildrenNodes(){if(this.noneFunctionalComponentMode)return this.$children[0].$slots.default;const e=this.$slots.default;return this.transitionMode?e[0].child.$slots.default:e},computeIndexes(){this.$nextTick(()=>{this.visibleIndexes=ve(this.getChildrenNodes(),this.rootContainer.children,this.transitionMode,this.footerOffset)})},getUnderlyingVm(e){const t=ge(this.getChildrenNodes()||[],e);if(t===-1)return null;const n=this.realList[t];return{index:t,element:n}},getUnderlyingPotencialDraggableComponent({__vue__:e}){return!e||!e.$options||!R(e.$options._componentTag)?!("realList"in e)&&e.$children.length===1&&"realList"in e.$children[0]?e.$children[0]:e:e.$parent},emitChanges(e){this.$nextTick(()=>{this.$emit("change",e)})},alterList(e){if(this.list){e(this.list);return}const t=[...this.value];e(t),this.$emit("input",t)},spliceList(){const e=t=>t.splice(...arguments);this.alterList(e)},updatePosition(e,t){const n=o=>o.splice(t,0,o.splice(e,1)[0]);this.alterList(n)},getRelatedContextFromMoveEvent({to:e,related:t}){const n=this.getUnderlyingPotencialDraggableComponent(e);if(!n)return{component:n};const o=n.realList,i={list:o,component:n};if(e!==t&&o&&n.getUnderlyingVm){const r=n.getUnderlyingVm(t);if(r)return Object.assign(r,i)}return i},getVmIndex(e){const t=this.visibleIndexes,n=t.length;return e>n-1?n:t[e]},getComponent(){return this.$slots.default[0].componentInstance},resetTransitionData(e){if(!this.noTransitionOnDrag||!this.transitionMode)return;var t=this.getChildrenNodes();t[e].data=null;const n=this.getComponent();n.children=[],n.kept=void 0},onDragStart(e){this.context=this.getUnderlyingVm(e.item),e.item._underlying_vm_=this.clone(this.context.element),A=e.item},onDragAdd(e){const t=e.item._underlying_vm_;if(t===void 0)return;k(e.item);const n=this.getVmIndex(e.newIndex);this.spliceList(n,0,t),this.computeIndexes();const o={element:t,newIndex:n};this.emitChanges({added:o})},onDragRemove(e){if(j(this.rootContainer,e.item,e.oldIndex),e.pullMode==="clone"){k(e.clone);return}const t=this.context.index;this.spliceList(t,1);const n={element:this.context.element,oldIndex:t};this.resetTransitionData(t),this.emitChanges({removed:n})},onDragUpdate(e){k(e.item),j(e.from,e.item,e.oldIndex);const t=this.context.index,n=this.getVmIndex(e.newIndex);this.updatePosition(t,n);const o={element:this.context.element,oldIndex:t,newIndex:n};this.emitChanges({moved:o})},updateProperty(e,t){e.hasOwnProperty(t)&&(e[t]+=this.headerOffset)},computeFutureIndex(e,t){if(!e.element)return 0;const n=[...t.to.children].filter(u=>u.style.display!=="none"),o=n.indexOf(t.related),i=e.component.getVmIndex(o);return n.indexOf(A)!==-1||!t.willInsertAfter?i:i+1},onDragMove(e,t){const n=this.move;if(!n||!this.realList)return!0;const o=this.getRelatedContextFromMoveEvent(e),i=this.context,r=this.computeFutureIndex(o,e);Object.assign(i,{futureIndex:r});const u=Object.assign({},e,{relatedContext:o,draggedContext:i});return n(u,t)},onDragEnd(){this.computeIndexes(),A=null}}};typeof window<"u"&&"Vue"in window&&window.Vue.component("draggable",J);const Ie=q("implementation",()=>{const e=b({});function t(i,r){e.value[i]=r}function n(i){return e.value[i]||[]}function o(i,r,u){const m=e.value[i];if(m){const p=m.find(v=>v.id===r);p&&(p.status=u)}}return{projectNodes:e,saveProjectNodes:t,getProjectNodes:n,updateProjectNodeStatus:o}}),V=["materials","review","decision"],Oe=q("approval",()=>{const e=b([{id:"A001",title:"智能水表项目立项",applicant:"王五",department:"技术部",year:2024,duration:18,status:"未通过",budget:200,applyTime:"2024-01-15",fileList:[{uid:"1",name:"项目申请书.pdf",status:"done"},{uid:"2",name:"技术方案.docx",status:"done"}]},{id:"A002",title:"管网监测优化立项",applicant:"赵六",department:"工程部",year:2024,duration:12,status:"通过",budget:150,applyTime:"2024-02-20",fileList:[{uid:"3",name:"立项申请表.pdf",status:"done"},{uid:"4",name:"预算明细.xlsx",status:"done"},{uid:"5",name:"可行性报告.docx",status:"done"}]},{id:"A003",title:"水厂自动化改造",applicant:"李明",department:"自动化部",year:2024,duration:24,status:"未通过",budget:180,applyTime:"2024-03-10",fileList:[]},{id:"A004",title:"管网智能监控平台",applicant:"王强",department:"信息部",year:2024,duration:15,status:"通过",budget:220,applyTime:"2024-03-25",fileList:[{uid:"6",name:"项目计划书.pdf",status:"done"}]}]);function t(n){const o=e.value.find(r=>r.id===n);if(!o)return null;const i=V.indexOf(o.node);return i<V.length-1?(o.node=V[i+1],o.nodeHistory||(o.nodeHistory=[]),o.nodeHistory.push({node:o.node,time:Date.now()}),o.node):null}return{approvalList:e,submitAndNext:t}});const Le={class:"implementation-nodes-page"},$e={class:"page-header"},Se={class:"header-content"},Te={class:"page-title"},Ne={class:"header-actions"},Ue={class:"node-item"},Me={__name:"index",setup(e){const t=b([{id:"P001",name:"项目A"},{id:"P002",name:"项目B"}]),n=b(""),o=b([{id:"N1",name:"首付款",percent:30,condition:"合同签订后7日内",dependency:""},{id:"N2",name:"中期款",percent:40,condition:"项目进度过半",dependency:"N1"},{id:"N3",name:"尾款",percent:30,condition:"项目验收合格",dependency:"N2"}]),r=re().templateList,u=b(),m=oe(),p=Ie();function v(C){const a=r.value.find(h=>h.id===C);a&&(o.value=a.nodes.map(h=>({...h,id:Math.random().toString(36).slice(2,10)})))}function W(){m.push({path:"/implementation/template"})}function G(){o.value.push({id:Math.random().toString(36).slice(2,10),name:"",percent:0,condition:"",dependency:null,deadline:null,attachments:[]})}function X(C){o.value.splice(C,1)}function Y(){if(!n.value){$.error("请先选择项目");return}le.confirm({title:`是否将当前配置保存到${n.value}项目？`,onOk:()=>{$.success("保存成功！")}})}function Z(){if(!n.value){$.error("请先选择项目");return}p.saveProjectNodes(n.value,o.value);const a=Oe().approvalList.find(h=>h.id===n.value);a&&(a.nodeConfigured=!0),$.success("节点配置已发布到实施流程")}const w=ie();return se(()=>{if(w.query.projectId&&(n.value=w.query.projectId),w.query.nodes)try{o.value=JSON.parse(w.query.nodes)}catch{}}),(C,a)=>{const h=g("a-select-option"),S=g("a-select"),y=g("a-button"),T=g("a-card"),P=g("a-input"),K=g("a-input-number"),Q=g("a-date-picker"),ee=g("a-upload"),te=g("a-alert");return x(),I("div",Le,[_("div",$e,[_("div",Se,[_("h1",Te,[d(O(de)),a[3]||(a[3]=f(" 节点管理计划 ",-1))]),a[4]||(a[4]=_("p",{class:"page-desc"},"配置项目实施节点，支持拖拽排序、属性编辑、依赖关系与流程预览",-1))]),_("div",Ne,[d(S,{value:n.value,"onUpdate:value":a[0]||(a[0]=s=>n.value=s),placeholder:"选择项目",style:{width:"220px","margin-right":"12px"}},{default:c(()=>[(x(!0),I(N,null,U(t.value,s=>(x(),M(h,{key:s.id,value:s.id},{default:c(()=>[f(L(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),d(y,{type:"primary",onClick:Y},{default:c(()=>a[5]||(a[5]=[f("保存配置",-1)])),_:1,__:[5]}),d(y,{type:"dashed",onClick:Z},{default:c(()=>a[6]||(a[6]=[f("发布到实施流程",-1)])),_:1,__:[6]})])]),d(T,{class:"template-section",title:"节点模板库"},{default:c(()=>[d(S,{value:u.value,"onUpdate:value":a[1]||(a[1]=s=>u.value=s),placeholder:"选择模板",style:{width:"220px"},onChange:v},{default:c(()=>[(x(!0),I(N,null,U(O(r),s=>(x(),M(h,{key:s.id,value:s.id},{default:c(()=>[f(L(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),d(y,{type:"link",onClick:W},{default:c(()=>a[7]||(a[7]=[f("管理模板",-1)])),_:1,__:[7]})]),_:1}),d(T,{class:"nodes-section",title:"节点配置"},{default:c(()=>[d(O(J),{modelValue:o.value,"onUpdate:modelValue":a[2]||(a[2]=s=>o.value=s),"item-key":"id",animation:"200"},{item:c(({element:s,index:ne})=>[_("div",Ue,[a[9]||(a[9]=_("span",{class:"drag-handle"},"☰",-1)),d(P,{value:s.name,"onUpdate:value":l=>s.name=l,placeholder:"节点名称",style:{width:"120px","margin-right":"8px"}},null,8,["value","onUpdate:value"]),d(K,{value:s.percent,"onUpdate:value":l=>s.percent=l,min:0,max:100,style:{width:"80px","margin-right":"8px"},placeholder:"金额"},null,8,["value","onUpdate:value"]),d(P,{value:s.condition,"onUpdate:value":l=>s.condition=l,placeholder:"条件说明",style:{width:"180px","margin-right":"8px"}},null,8,["value","onUpdate:value"]),d(Q,{value:s.deadline,"onUpdate:value":l=>s.deadline=l,placeholder:"截止日期",style:{width:"140px","margin-right":"8px"},disabledDate:l=>l&&l<O(ue)().startOf("day")},null,8,["value","onUpdate:value","disabledDate"]),d(S,{value:s.dependency,"onUpdate:value":l=>s.dependency=l,placeholder:"节点数据类型",allowClear:"",style:{width:"120px","margin-right":"8px"}},{default:c(()=>[(x(!0),I(N,null,U(o.value.filter(l=>l.id!==s.id),l=>(x(),M(h,{key:l.id,value:l.id},{default:c(()=>[f(L(l.name),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),d(ee,{"file-list":s.attachments,"onUpdate:fileList":l=>s.attachments=l,"before-upload":()=>!1,"max-count":3,style:{width:"120px","margin-right":"8px"}},{default:c(()=>[d(y,{type:"link",size:"small"},{default:c(()=>{var l;return[f(L((l=s.attachments)!=null&&l.length?`已上传${s.attachments.length}个文件`:"上传附件"),1)]}),_:2},1024)]),_:2},1032,["file-list","onUpdate:fileList"]),d(y,{type:"link",danger:"",size:"small",onClick:l=>X(ne)},{default:c(()=>a[8]||(a[8]=[f("移除",-1)])),_:2,__:[8]},1032,["onClick"])])]),_:1},8,["modelValue"]),d(y,{type:"dashed",onClick:G,style:{"margin-top":"12px"}},{default:c(()=>a[10]||(a[10]=[f("添加节点",-1)])),_:1,__:[10]})]),_:1}),d(T,{class:"flow-section",title:"流程图预览"},{default:c(()=>[d(te,{message:"流程图预览功能开发中...",type:"info","show-icon":""})]),_:1})])}}},Pe=ce(Me,[["__scopeId","data-v-004e43af"]]);export{Pe as default};
