import{r as ae,c as P,a4 as oe,f as B,o as se,b as re,w as ie,S as U,U as _,V as y,W as v,k as f,u as S,G as w,Z as F,X as h,F as ne,Y as le,a0 as I,$ as de,_ as M}from"./vendor-9e962977.js";import{m as l,F as ce,a0 as ue,N as pe,ae as me,J as ge,t as fe,H as _e,x as ve}from"./antd-3abeaf7b.js";import{_ as he}from"./index-b9d63c8b.js";const r=ae({configs:{apply:[],opening:[],midterm:[],acceptance:[]},loading:!1,lastUpdateTime:null,version:"1.0.0"}),ye={apply:"立项申请",opening:"项目开题",midterm:"项目中期",acceptance:"项目验收"},b=()=>({apply:[{id:1,categoryName:"项目申请书",isRequired:!0,templateFileName:"项目申请书模板.docx",templateFilePath:"/templates/apply/project_application.docx",sortOrder:1,description:"详细的项目申请信息，包含项目背景、目标、实施方案等",businessType:"apply",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:2,categoryName:"可行性研究报告",isRequired:!0,templateFileName:"可行性研究报告模板.docx",templateFilePath:"/templates/apply/feasibility_study.docx",sortOrder:2,description:"项目技术可行性、经济可行性分析报告",businessType:"apply",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],opening:[{id:11,categoryName:"开题报告",isRequired:!0,templateFileName:"开题报告模板.docx",templateFilePath:"/templates/opening/opening_report.docx",sortOrder:1,description:"项目开题报告，说明研究方案和计划",businessType:"opening",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],midterm:[{id:21,categoryName:"中期报告",isRequired:!0,templateFileName:"中期报告模板.docx",templateFilePath:"/templates/midterm/midterm_report.docx",sortOrder:1,description:"项目中期进展报告",businessType:"midterm",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],acceptance:[{id:31,categoryName:"验收报告",isRequired:!0,templateFileName:"验收报告模板.docx",templateFilePath:"/templates/acceptance/acceptance_report.docx",sortOrder:1,description:"项目验收报告",businessType:"acceptance",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}]}),q=new Map,V=e=>r.configs[e]||[],Se=P(()=>{const e={};return Object.keys(r.configs).forEach(o=>{const s=r.configs[o]||[];e[o]={total:s.length,required:s.filter(i=>i.isRequired).length,optional:s.filter(i=>!i.isRequired).length}}),e}),j=()=>{try{const e=localStorage.getItem("materialTemplateConfigs");if(e){const o=JSON.parse(e);return r.configs=o.configs||{},r.version=o.version||"1.0.0",r.lastUpdateTime=o.lastUpdateTime,!0}}catch(e){console.error("加载配置失败:",e)}return!1},x=()=>{try{const e={configs:r.configs,version:r.version,lastUpdateTime:r.lastUpdateTime};return localStorage.setItem("materialTemplateConfigs",JSON.stringify(e)),!0}catch(e){return console.error("保存配置失败:",e),!1}},we=async()=>{r.loading=!0;try{j()||(r.configs=b(),r.lastUpdateTime=new Date().toISOString(),x()),l.success("配置加载成功")}catch(e){console.error("初始化配置失败:",e),l.error("配置加载失败")}finally{r.loading=!1}},Ce=async(e,o)=>{try{const s={...o,id:Date.now(),businessType:e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return r.configs[e]||(r.configs[e]=[]),r.configs[e].push(s),r.lastUpdateTime=new Date().toISOString(),x(),C(e),l.success("添加配置成功"),s}catch(s){throw console.error("添加配置失败:",s),l.error("添加配置失败"),s}},xe=async(e,o,s)=>{try{const i=r.configs[e]||[],u=i.findIndex(D=>D.id===o);if(u===-1)throw new Error("配置项不存在");const k={...i[u],...s,updatedAt:new Date().toISOString()};return r.configs[e][u]=k,r.lastUpdateTime=new Date().toISOString(),x(),C(e),l.success("更新配置成功"),k}catch(i){throw console.error("更新配置失败:",i),l.error("更新配置失败"),i}},Oe=async(e,o)=>{try{const i=(r.configs[e]||[]).findIndex(u=>u.id===o);if(i===-1)throw new Error("配置项不存在");return r.configs[e].splice(i,1),r.lastUpdateTime=new Date().toISOString(),x(),C(e),l.success("删除配置成功"),!0}catch(s){throw console.error("删除配置失败:",s),l.error("删除配置失败"),s}},Ue=async(e,o)=>{try{return r.configs[e]=o.map(s=>({...s,businessType:e,updatedAt:new Date().toISOString()})),r.lastUpdateTime=new Date().toISOString(),x(),C(e),l.success("批量更新配置成功"),!0}catch(s){throw console.error("批量更新配置失败:",s),l.error("批量更新配置失败"),s}},qe=async e=>{try{const o=b();return e?r.configs[e]=o[e]||[]:r.configs=o,r.lastUpdateTime=new Date().toISOString(),x(),e?C(e):Object.keys(o).forEach(s=>{C(s)}),l.success("重置配置成功"),!0}catch(o){throw console.error("重置配置失败:",o),l.error("重置配置失败"),o}},C=e=>{const o=q.get(e);if(o&&o.size>0){const s=V(e);o.forEach(i=>{try{i(s,e)}catch(u){console.error("页面更新回调执行失败:",u)}})}},De=(e,o)=>(q.has(e)||q.set(e,new Set),q.get(e).add(o),()=>{const s=q.get(e);s&&(s.delete(o),s.size===0&&q.delete(e))}),E={state:r,businessTypeMap:ye,getConfigsStats:Se,initConfigs:we,getConfigsByBusinessType:V,addConfig:Ce,updateConfig:xe,deleteConfig:Oe,batchUpdateConfigs:Ue,resetToDefault:qe,registerPageUpdateListener:De,notifyBusinessPageUpdate:C,saveConfigsToStorage:x,loadConfigsFromStorage:j};const Fe={class:"material-template-sync"},Ie={class:"material-submit-section"},ke={class:"section-header"},Ne={class:"header-actions"},Re={key:0,class:"material-list"},Ee={class:"material-info"},Te={class:"material-title"},Ae={class:"category-name"},ze={key:0,class:"material-desc"},Be={key:1,class:"template-download"},Me={class:"upload-area"},Le={key:0,class:"uploaded-file"},$e={class:"file-info"},Pe={class:"file-name"},be={key:1,class:"empty-state"},Ve={key:2,class:"submit-summary"},je={__name:"MaterialTemplateSync",props:{businessType:{type:String,required:!0,validator:e=>["apply","opening","midterm","acceptance"].includes(e)},autoLoad:{type:Boolean,default:!0},showActions:{type:Boolean,default:!0}},emits:["files-change","validation-change","config-update"],setup(e,{expose:o,emit:s}){const i=e,u=s,k=oe(),D=B(!1),m=B([]),g=B(new Map),{businessTypeMap:J}=E,O=P(()=>m.value.filter(a=>a.isRequired).every(a=>g.value.has(a.id))),G=()=>{const t=m.value.length,a=m.value.filter(p=>p.isRequired).length,d=g.value.size,c=m.value.filter(p=>p.isRequired).filter(p=>g.value.has(p.id)).length;return O.value?`已上传 ${d}/${t} 个文件，所有必传材料已完成`:`已上传 ${c}/${a} 个必传材料，还需上传 ${a-c} 个必传文件`},T=t=>g.value.get(t),L=async()=>{await N()},N=async()=>{D.value=!0;try{const t=E.getConfigsByBusinessType(i.businessType);m.value=t.sort((a,d)=>(a.sortOrder||0)-(d.sortOrder||0)),u("config-update",t)}catch(t){console.error("加载配置失败:",t),l.error("加载配置失败")}finally{D.value=!1}},H=(t,a)=>{if(t.size>52428800)return l.error("文件大小不能超过50MB"),!1;if(a.templateFileName){const c=a.templateFileName.split(".").pop().toLowerCase(),p=t.name.split(".").pop().toLowerCase(),R={docx:["docx","doc","pdf"],doc:["docx","doc","pdf"],xlsx:["xlsx","xls"],xls:["xlsx","xls"],pdf:["pdf","docx","doc"]}[c]||[c];if(!R.includes(p))return l.error(`请上传 ${R.join("、")} 格式的文件`),!1}return g.value.set(a.id,t),u("files-change",{configId:a.id,file:t,action:"add"}),u("validation-change",{allRequiredUploaded:O.value,uploadedCount:g.value.size,totalCount:m.value.length}),l.success(`文件 "${t.name}" 已选择`),!1},W=t=>{const a=g.value.get(t);a&&(g.value.delete(t),u("files-change",{configId:t,file:a,action:"remove"}),u("validation-change",{allRequiredUploaded:O.value,uploadedCount:g.value.size,totalCount:m.value.length}),l.success("文件已移除"))},X=t=>{l.info(`正在下载模板：${t.templateFileName}`)},Y=()=>{k.push("/settings/material-template")},Z=()=>{const t=[];return g.value.forEach((a,d)=>{const c=m.value.find(p=>p.id===d);t.push({configId:d,config:c,file:a})}),t},K=()=>({valid:O.value,missingFiles:m.value.filter(t=>t.isRequired&&!g.value.has(t.id)).map(t=>t.categoryName)}),Q=()=>{g.value.clear(),u("validation-change",{allRequiredUploaded:!1,uploadedCount:0,totalCount:m.value.length}),l.success("已清空所有文件")};let A=null;const ee=()=>{A=E.registerPageUpdateListener(i.businessType,t=>{m.value=t.sort((c,p)=>(c.sortOrder||0)-(p.sortOrder||0));const a=new Set(t.map(c=>c.id)),d=[];g.value.forEach((c,p)=>{a.has(p)||d.push(p)}),d.forEach(c=>{g.value.delete(c)}),u("config-update",t),d.length>0&&u("validation-change",{allRequiredUploaded:O.value,uploadedCount:g.value.size,totalCount:m.value.length})})};return se(async()=>{i.autoLoad&&(await E.initConfigs(),await N()),ee()}),re(()=>{A&&A()}),ie(()=>i.businessType,async()=>{i.autoLoad&&await N()},{immediate:!1}),o({refreshConfigs:L,getAllUploadedFiles:Z,validateRequiredFiles:K,clearAllFiles:Q,loadConfigs:N}),(t,a)=>{const d=U("a-button"),c=U("a-tag"),p=U("a-tooltip"),$=U("a-upload"),R=U("a-empty"),te=U("a-alert");return _(),y("div",Fe,[v("div",Ie,[v("div",ke,[v("h4",null,[f(S(ce)),w(" "+F(S(J)[e.businessType]||"材料")+"提交 ",1)]),v("div",Ne,[f(d,{type:"link",size:"small",onClick:L,loading:D.value},{default:h(()=>[f(S(ue)),a[0]||(a[0]=w(" 刷新配置 ",-1))]),_:1,__:[0]},8,["loading"])])]),m.value.length>0?(_(),y("div",Re,[(_(!0),y(ne,null,le(m.value,n=>(_(),y("div",{key:n.id,class:de(["material-item",{required:n.isRequired}])},[v("div",Ee,[v("div",Te,[v("span",Ae,[w(F(n.categoryName)+" ",1),n.isRequired?(_(),M(c,{key:0,color:"red",size:"small"},{default:h(()=>a[1]||(a[1]=[w("必传",-1)])),_:1,__:[1]})):(_(),M(c,{key:1,color:"blue",size:"small"},{default:h(()=>a[2]||(a[2]=[w("选传",-1)])),_:1,__:[2]}))]),n.description?(_(),M(p,{key:0,title:n.description},{default:h(()=>[f(S(me),{class:"info-icon"})]),_:2},1032,["title"])):I("",!0)]),n.description?(_(),y("div",ze,F(n.description),1)):I("",!0),n.templateFileName?(_(),y("div",Be,[f(d,{type:"link",size:"small",onClick:z=>X(n),class:"template-link"},{default:h(()=>[f(S(ge)),w(" 下载模板："+F(n.templateFileName),1)]),_:2},1032,["onClick"])])):I("",!0)]),v("div",Me,[f($,{name:`file_${n.id}`,multiple:!1,"show-upload-list":!1,"before-upload":z=>H(z,n),class:"material-upload"},{default:h(()=>[f(d,{type:"primary",size:n.isRequired?"default":"small",danger:n.isRequired&&!T(n.id)},{default:h(()=>[f(S(fe)),a[3]||(a[3]=w(" 选择文件 ",-1))]),_:2,__:[3]},1032,["size","danger"])]),_:2},1032,["name","before-upload"]),T(n.id)?(_(),y("div",Le,[v("div",$e,[f(S(_e)),v("span",Pe,F(T(n.id).name),1),f(d,{type:"link",size:"small",danger:"",onClick:z=>W(n.id)},{default:h(()=>[f(S(ve))]),_:2},1032,["onClick"])])])):I("",!0)])],2))),128))])):(_(),y("div",be,[f(R,{image:S(pe).PRESENTED_IMAGE_SIMPLE,description:"暂无配置的材料类目"},{default:h(()=>[f(d,{type:"primary",onClick:Y},{default:h(()=>a[4]||(a[4]=[w(" 前往配置 ",-1)])),_:1,__:[4]})]),_:1},8,["image"])])),m.value.length>0?(_(),y("div",Ve,[f(te,{type:O.value?"success":"warning",message:G(),"show-icon":""},null,8,["type","message"])])):I("",!0)])])}}},We=he(je,[["__scopeId","data-v-26dcd9be"]]);export{We as M,E as m};
