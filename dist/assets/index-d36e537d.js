import{S as g,O as le,d as de,l as P,n as B,a8 as H,f as C,a4 as ue,a5 as ce,o as pe,U as y,V as S,W as v,k as u,u as k,G as f,X as c,F as D,Y as N,Z as L,_ as A}from"./vendor-9e962977.js";import{S as me,u as fe}from"./nodeTemplate-973f13e7.js";import{m as E,W as ge,a3 as he,o as _e}from"./antd-3abeaf7b.js";import{_ as xe}from"./index-b9d63c8b.js";function F(e){e.parentElement!==null&&e.parentElement.removeChild(e)}function M(e,t,n){const o=n===0?e.children[0]:e.children[n-1].nextSibling;e.insertBefore(t,o)}function ye(){return typeof window<"u"?window.console:global.console}const ve=ye();function be(e){const t=Object.create(null);return function(o){return t[o]||(t[o]=e(o))}}const Ce=/-(\w)/g,Ie=be(e=>e.replace(Ce,(t,n)=>n.toUpperCase())),W=["Start","Add","Remove","Update","End"],z=["Choose","Unchoose","Sort","Filter","Clone"],K=["Move"],we=[K,W,z].flatMap(e=>e).map(e=>`on${e}`),$={manage:K,manageAndEmit:W,emit:z};function Se(e){return we.indexOf(e)!==-1}const ke=["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","label","legend","li","link","main","map","mark","math","menu","menuitem","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","param","picture","pre","progress","q","rb","rp","rt","rtc","ruby","s","samp","script","section","select","slot","small","source","span","strong","style","sub","summary","sup","svg","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"];function Le(e){return ke.includes(e)}function Ee(e){return["transition-group","TransitionGroup"].includes(e)}function G(e){return["id","class","role","style"].includes(e)||e.startsWith("data-")||e.startsWith("aria-")||e.startsWith("on")}function J(e){return e.reduce((t,[n,o])=>(t[n]=o,t),{})}function Ue({$attrs:e,componentData:t={}}){return{...J(Object.entries(e).filter(([o,a])=>G(o))),...t}}function Ve({$attrs:e,callBackBuilder:t}){const n=J(X(e));Object.entries(t).forEach(([a,i])=>{$[a].forEach(d=>{n[`on${d}`]=i(d)})});const o=`[data-draggable]${n.draggable||""}`;return{...n,draggable:o}}function X(e){return Object.entries(e).filter(([t,n])=>!G(t)).map(([t,n])=>[Ie(t),n]).filter(([t,n])=>!Se(t))}const q=({el:e})=>e,De=(e,t)=>e.__draggable_context=t,R=e=>e.__draggable_context;class Ne{constructor({nodes:{header:t,default:n,footer:o},root:a,realList:i}){this.defaultNodes=n,this.children=[...t,...n,...o],this.externalComponent=a.externalComponent,this.rootTransition=a.transition,this.tag=a.tag,this.realList=i}get _isRootComponent(){return this.externalComponent||this.rootTransition}render(t,n){const{tag:o,children:a,_isRootComponent:i}=this;return t(o,n,i?{default:()=>a}:a)}updated(){const{defaultNodes:t,realList:n}=this;t.forEach((o,a)=>{De(q(o),{element:n[a],index:a})})}getUnderlyingVm(t){return R(t)}getVmIndexFromDomIndex(t,n){const{defaultNodes:o}=this,{length:a}=o,i=n.children,d=i.item(t);if(d===null)return a;const p=R(d);if(p)return p.index;if(a===0)return 0;const m=q(o[0]),x=[...i].findIndex(_=>_===m);return t<x?0:a}}function Ae(e,t){const n=e[t];return n?n():[]}function Fe({$slots:e,realList:t,getKey:n}){const o=t||[],[a,i]=["header","footer"].map(m=>Ae(e,m)),{item:d}=e;if(!d)throw new Error("draggable element must have an item slot");const p=o.flatMap((m,x)=>d({element:m,index:x}).map(_=>(_.key=n(m),_.props={..._.props||{},"data-draggable":!0},_)));if(p.length!==o.length)throw new Error("Item slot must have only one child");return{header:a,footer:i,default:p}}function Te(e){const t=Ee(e),n=!Le(e)&&!t;return{transition:t,externalComponent:n,tag:n?g(e):t?le:e}}function Oe({$slots:e,tag:t,realList:n,getKey:o}){const a=Fe({$slots:e,realList:n,getKey:o}),i=Te(t);return new Ne({nodes:a,root:i,realList:n})}function Y(e,t){B(()=>this.$emit(e.toLowerCase(),t))}function Z(e){return(t,n)=>{if(this.realList!==null)return this[`onDrag${e}`](t,n)}}function $e(e){const t=Z.call(this,e);return(n,o)=>{t.call(this,n,o),Y.call(this,e,n)}}let T=null;const je={list:{type:Array,required:!1,default:null},modelValue:{type:Array,required:!1,default:null},itemKey:{type:[String,Function],required:!0},clone:{type:Function,default:e=>e},tag:{type:String,default:"div"},move:{type:Function,default:null},componentData:{type:Object,required:!1,default:null}},Pe=["update:modelValue","change",...[...$.manageAndEmit,...$.emit].map(e=>e.toLowerCase())],Me=de({name:"draggable",inheritAttrs:!1,props:je,emits:Pe,data(){return{error:!1}},render(){try{this.error=!1;const{$slots:e,$attrs:t,tag:n,componentData:o,realList:a,getKey:i}=this,d=Oe({$slots:e,tag:n,realList:a,getKey:i});this.componentStructure=d;const p=Ue({$attrs:t,componentData:o});return d.render(P,p)}catch(e){return this.error=!0,P("pre",{style:{color:"red"}},e.stack)}},created(){this.list!==null&&this.modelValue!==null&&ve.error("modelValue and list props are mutually exclusive! Please set one or another.")},mounted(){if(this.error)return;const{$attrs:e,$el:t,componentStructure:n}=this;n.updated();const o=Ve({$attrs:e,callBackBuilder:{manageAndEmit:i=>$e.call(this,i),emit:i=>Y.bind(this,i),manage:i=>Z.call(this,i)}}),a=t.nodeType===1?t:t.parentElement;this._sortable=new me(a,o),this.targetDomElement=a,a.__draggable_component__=this},updated(){this.componentStructure.updated()},beforeUnmount(){this._sortable!==void 0&&this._sortable.destroy()},computed:{realList(){const{list:e}=this;return e||this.modelValue},getKey(){const{itemKey:e}=this;return typeof e=="function"?e:t=>t[e]}},watch:{$attrs:{handler(e){const{_sortable:t}=this;t&&X(e).forEach(([n,o])=>{t.option(n,o)})},deep:!0}},methods:{getUnderlyingVm(e){return this.componentStructure.getUnderlyingVm(e)||null},getUnderlyingPotencialDraggableComponent(e){return e.__draggable_component__},emitChanges(e){B(()=>this.$emit("change",e))},alterList(e){if(this.list){e(this.list);return}const t=[...this.modelValue];e(t),this.$emit("update:modelValue",t)},spliceList(){const e=t=>t.splice(...arguments);this.alterList(e)},updatePosition(e,t){const n=o=>o.splice(t,0,o.splice(e,1)[0]);this.alterList(n)},getRelatedContextFromMoveEvent({to:e,related:t}){const n=this.getUnderlyingPotencialDraggableComponent(e);if(!n)return{component:n};const o=n.realList,a={list:o,component:n};return e!==t&&o?{...n.getUnderlyingVm(t)||{},...a}:a},getVmIndexFromDomIndex(e){return this.componentStructure.getVmIndexFromDomIndex(e,this.targetDomElement)},onDragStart(e){this.context=this.getUnderlyingVm(e.item),e.item._underlying_vm_=this.clone(this.context.element),T=e.item},onDragAdd(e){const t=e.item._underlying_vm_;if(t===void 0)return;F(e.item);const n=this.getVmIndexFromDomIndex(e.newIndex);this.spliceList(n,0,t);const o={element:t,newIndex:n};this.emitChanges({added:o})},onDragRemove(e){if(M(this.$el,e.item,e.oldIndex),e.pullMode==="clone"){F(e.clone);return}const{index:t,element:n}=this.context;this.spliceList(t,1);const o={element:n,oldIndex:t};this.emitChanges({removed:o})},onDragUpdate(e){F(e.item),M(e.from,e.item,e.oldIndex);const t=this.context.index,n=this.getVmIndexFromDomIndex(e.newIndex);this.updatePosition(t,n);const o={element:this.context.element,oldIndex:t,newIndex:n};this.emitChanges({moved:o})},computeFutureIndex(e,t){if(!e.element)return 0;const n=[...t.to.children].filter(d=>d.style.display!=="none"),o=n.indexOf(t.related),a=e.component.getVmIndexFromDomIndex(o);return n.indexOf(T)!==-1||!t.willInsertAfter?a:a+1},onDragMove(e,t){const{move:n,realList:o}=this;if(!n||!o)return!0;const a=this.getRelatedContextFromMoveEvent(e),i=this.computeFutureIndex(a,e),d={...this.context,futureIndex:i},p={...e,relatedContext:a,draggedContext:d};return n(p,t)},onDragEnd(){T=null}}}),qe=H("implementation",()=>{const e=C({});function t(a,i){e.value[a]=i}function n(a){return e.value[a]||[]}function o(a,i,d){const p=e.value[a];if(p){const m=p.find(x=>x.id===i);m&&(m.status=d)}}return{projectNodes:e,saveProjectNodes:t,getProjectNodes:n,updateProjectNodeStatus:o}}),O=["materials","review","decision"],Re=H("approval",()=>{const e=C([{id:"A001",title:"智能水表项目立项",applicant:"王五",department:"技术部",year:2024,duration:18,status:"未通过",budget:200,applyTime:"2024-01-15",fileList:[{uid:"1",name:"项目申请书.pdf",status:"done"},{uid:"2",name:"技术方案.docx",status:"done"}]},{id:"A002",title:"管网监测优化立项",applicant:"赵六",department:"工程部",year:2024,duration:12,status:"通过",budget:150,applyTime:"2024-02-20",fileList:[{uid:"3",name:"立项申请表.pdf",status:"done"},{uid:"4",name:"预算明细.xlsx",status:"done"},{uid:"5",name:"可行性报告.docx",status:"done"}]},{id:"A003",title:"水厂自动化改造",applicant:"李明",department:"自动化部",year:2024,duration:24,status:"未通过",budget:180,applyTime:"2024-03-10",fileList:[]},{id:"A004",title:"管网智能监控平台",applicant:"王强",department:"信息部",year:2024,duration:15,status:"通过",budget:220,applyTime:"2024-03-25",fileList:[{uid:"6",name:"项目计划书.pdf",status:"done"}]}]);function t(n){const o=e.value.find(i=>i.id===n);if(!o)return null;const a=O.indexOf(o.node);return a<O.length-1?(o.node=O[a+1],o.nodeHistory||(o.nodeHistory=[]),o.nodeHistory.push({node:o.node,time:Date.now()}),o.node):null}return{approvalList:e,submitAndNext:t}});const Be={class:"implementation-nodes-page"},He={class:"page-header"},We={class:"header-content"},ze={class:"page-title"},Ke={class:"header-actions"},Ge={class:"node-item"},Je={__name:"index",setup(e){const t=C([{id:"P001",name:"项目A"},{id:"P002",name:"项目B"}]),n=C(""),o=C([{id:"N1",name:"首付款",percent:30,condition:"合同签订后7日内",dependency:""},{id:"N2",name:"中期款",percent:40,condition:"项目进度过半",dependency:"N1"},{id:"N3",name:"尾款",percent:30,condition:"项目验收合格",dependency:"N2"}]),i=fe().templateList,d=C(),p=ue(),m=qe();function x(I){const s=i.value.find(h=>h.id===I);s&&(o.value=s.nodes.map(h=>({...h,id:Math.random().toString(36).slice(2,10)})))}function _(){p.push({path:"/implementation/template"})}function Q(){o.value.push({id:Math.random().toString(36).slice(2,10),name:"",percent:0,condition:"",dependency:null,deadline:null,attachments:[]})}function ee(I){o.value.splice(I,1)}function te(){if(!n.value){E.error("请先选择项目");return}ge.confirm({title:`是否将当前配置保存到${n.value}项目？`,onOk:()=>{E.success("保存成功！")}})}function ne(){if(!n.value){E.error("请先选择项目");return}m.saveProjectNodes(n.value,o.value);const s=Re().approvalList.find(h=>h.id===n.value);s&&(s.nodeConfigured=!0),E.success("节点配置已发布到实施流程")}const w=ce();return pe(()=>{if(w.query.projectId&&(n.value=w.query.projectId),w.query.nodes)try{o.value=JSON.parse(w.query.nodes)}catch{}}),(I,s)=>{const h=g("a-select-option"),U=g("a-select"),b=g("a-button"),V=g("a-card"),j=g("a-input"),oe=g("a-input-number"),ae=g("a-date-picker"),ie=g("a-upload"),re=g("a-alert");return y(),S("div",Be,[v("div",He,[v("div",We,[v("h1",ze,[u(k(he)),s[3]||(s[3]=f(" 节点管理计划 ",-1))]),s[4]||(s[4]=v("p",{class:"page-desc"},"配置项目实施节点，支持拖拽排序、属性编辑、依赖关系与流程预览",-1))]),v("div",Ke,[u(U,{value:n.value,"onUpdate:value":s[0]||(s[0]=r=>n.value=r),placeholder:"选择项目",style:{width:"220px","margin-right":"12px"}},{default:c(()=>[(y(!0),S(D,null,N(t.value,r=>(y(),A(h,{key:r.id,value:r.id},{default:c(()=>[f(L(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),u(b,{type:"primary",onClick:te},{default:c(()=>s[5]||(s[5]=[f("保存配置",-1)])),_:1,__:[5]}),u(b,{type:"dashed",onClick:ne},{default:c(()=>s[6]||(s[6]=[f("发布到实施流程",-1)])),_:1,__:[6]})])]),u(V,{class:"template-section",title:"节点模板库"},{default:c(()=>[u(U,{value:d.value,"onUpdate:value":s[1]||(s[1]=r=>d.value=r),placeholder:"选择模板",style:{width:"220px"},onChange:x},{default:c(()=>[(y(!0),S(D,null,N(k(i),r=>(y(),A(h,{key:r.id,value:r.id},{default:c(()=>[f(L(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"]),u(b,{type:"link",onClick:_},{default:c(()=>s[7]||(s[7]=[f("管理模板",-1)])),_:1,__:[7]})]),_:1}),u(V,{class:"nodes-section",title:"节点配置"},{default:c(()=>[u(k(Me),{modelValue:o.value,"onUpdate:modelValue":s[2]||(s[2]=r=>o.value=r),"item-key":"id",animation:"200"},{item:c(({element:r,index:se})=>[v("div",Ge,[s[9]||(s[9]=v("span",{class:"drag-handle"},"☰",-1)),u(j,{value:r.name,"onUpdate:value":l=>r.name=l,placeholder:"节点名称",style:{width:"120px","margin-right":"8px"}},null,8,["value","onUpdate:value"]),u(oe,{value:r.percent,"onUpdate:value":l=>r.percent=l,min:0,max:100,style:{width:"80px","margin-right":"8px"},placeholder:"金额"},null,8,["value","onUpdate:value"]),u(j,{value:r.condition,"onUpdate:value":l=>r.condition=l,placeholder:"条件说明",style:{width:"180px","margin-right":"8px"}},null,8,["value","onUpdate:value"]),u(ae,{value:r.deadline,"onUpdate:value":l=>r.deadline=l,placeholder:"截止日期",style:{width:"140px","margin-right":"8px"},disabledDate:l=>l&&l<k(_e)().startOf("day")},null,8,["value","onUpdate:value","disabledDate"]),u(U,{value:r.dependency,"onUpdate:value":l=>r.dependency=l,placeholder:"节点数据类型",allowClear:"",style:{width:"120px","margin-right":"8px"}},{default:c(()=>[(y(!0),S(D,null,N(o.value.filter(l=>l.id!==r.id),l=>(y(),A(h,{key:l.id,value:l.id},{default:c(()=>[f(L(l.name),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["value","onUpdate:value"]),u(ie,{"file-list":r.attachments,"onUpdate:fileList":l=>r.attachments=l,"before-upload":()=>!1,"max-count":3,style:{width:"120px","margin-right":"8px"}},{default:c(()=>[u(b,{type:"link",size:"small"},{default:c(()=>{var l;return[f(L((l=r.attachments)!=null&&l.length?`已上传${r.attachments.length}个文件`:"上传附件"),1)]}),_:2},1024)]),_:2},1032,["file-list","onUpdate:fileList"]),u(b,{type:"link",danger:"",size:"small",onClick:l=>ee(se)},{default:c(()=>s[8]||(s[8]=[f("移除",-1)])),_:2,__:[8]},1032,["onClick"])])]),_:1},8,["modelValue"]),u(b,{type:"dashed",onClick:Q,style:{"margin-top":"12px"}},{default:c(()=>s[10]||(s[10]=[f("添加节点",-1)])),_:1,__:[10]})]),_:1}),u(V,{class:"flow-section",title:"流程图预览"},{default:c(()=>[u(re,{message:"流程图预览功能开发中...",type:"info","show-icon":""})]),_:1})])}}},et=xe(Je,[["__scopeId","data-v-004e43af"]]);export{et as default};
